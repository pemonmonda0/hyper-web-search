<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Hyper Web Search</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-6 max-w-xl mx-auto">

  <h1 class="text-2xl font-bold mb-4">Hyper Web Search</h1>

  <!-- キーワード入力 -->
  <input id="kw" type="text"
         placeholder="商品名 / JAN / 型番"
         class="w-full border rounded p-3 mb-4">

  <!-- サイト選択 -->
  <fieldset id="siteBox" class="flex flex-wrap gap-3 mb-6"></fieldset>

  <!-- 検索ボタン -->
  <button id="btnSearch"
          class="w-full bg-blue-600 text-white py-3 rounded hover:bg-blue-700">
    検索
  </button>

  <!-- 履歴 -->
  <h2 class="text-lg font-semibold mt-8 mb-2">履歴</h2>
  <div id="histBox" class="flex flex-wrap gap-3"></div>

  <script>
/* ---- 以前の Service Worker を完全解除 ---- */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations()
    .then(regs => regs.forEach(reg => reg.unregister()));
}
</script>

<script>
  
/* ===================== 1. 検索対象サイト設定 ===================== */
const SITES = [
  { id:'rakuten', label:'楽天',    color:'bg-red-500'   ,
    url:q=>`https://search.rakuten.co.jp/search/mall/${q}/?s=2`             },
  { id:'yahoo',   label:'Yahoo',   color:'bg-yellow-500',
    url:q=>`https://shopping.yahoo.co.jp/search?p=${q}&ss_sort=%2Bprice`    },
  { id:'amazon',  label:'Amazon',  color:'bg-neutral-800',
    url:q=>`https://www.amazon.co.jp/s?k=${q}&s=price-asc-rank`             },
  { id:'mercari', label:'メルカリ', color:'bg-orange-500',
    url:q=>`https://jp.mercari.com/search?keyword=${q}&sort=price_asc`      },
  { id:'yafuri',  label:'ヤフフリ', color:'bg-amber-700',
    url:q=>`https://auctions.yahoo.co.jp/search/search?p=${q}&slider=price` },
  { id:'rakuma',  label:'ラクマ',   color:'bg-pink-600' ,
    url:q=>`https://fril.jp/s?query=${q}&order=price_asc`                   }
];

/* ===================== 2. トグル（チェックボックス）生成 ===================== */
function buildSiteToggles(){
  const box = document.getElementById('siteBox');
  SITES.forEach(s=>{
    box.insertAdjacentHTML('beforeend', `
      <label class="flex items-center gap-1 cursor-pointer">
        <input type="checkbox" id="chk_${s.id}" class="accent-blue-600" checked>
        <span class="text-white ${s.color} px-3 py-1 rounded select-none">${s.label}</span>
      </label>
    `);
  });
}

/* ===================== 3. 検索実行 ===================== */
function openTabs(){
  const kw = document.getElementById('kw').value.trim();
  if(!kw){ alert('キーワードを入力してください'); return; }

  const q = encodeURIComponent(kw);
  SITES.forEach(s=>{
    if(document.getElementById(`chk_${s.id}`).checked){
      window.open(s.url(q), '_blank'+Math.random(), 'noopener');
    }
  });
  saveHist(kw);
}

/* ===================== 4. 直近10件ローカル履歴 ===================== */
function saveHist(kw){
  let hist = JSON.parse(localStorage.hist||'[]');
  hist = hist.filter(x=>x!==kw);   // 重複排除
  hist.unshift(kw);                // 先頭に追加
  hist = hist.slice(0,10);         // 10件制限
  localStorage.hist = JSON.stringify(hist);
  renderHist();
}

function renderHist(){
  const box  = document.getElementById('histBox');
  const data = JSON.parse(localStorage.hist||'[]');
  box.innerHTML='';
  data.forEach(k=>{
    box.insertAdjacentHTML('beforeend', `
      <button class="px-4 py-1 rounded-full bg-gray-200 hover:bg-gray-300"
              onclick="document.getElementById('kw').value='${k}'">
        ${k}
      </button>
    `);
  });
}

/* ===================== 初期化 ===================== */
buildSiteToggles();
renderHist();
document.getElementById('btnSearch').addEventListener('click', openTabs);
document.getElementById('kw').addEventListener('keydown', e=>{
  if(e.key==='Enter') openTabs();
});
</script>
</body>
</html>
